---
import Layout from '../../layouts/Layout.astro';
import { DashboardGrid } from '../../components/dashboard/DashboardGrid';
import { GenerationCounter } from '../../components/dashboard/GenerationCounter';
import { UserMenu } from '../../components/dashboard/UserMenu';
import type { DashboardDTO, UsageDailyDTO } from '../../types';

// This page requires authentication - middleware handles redirect
export const prerender = false;

// Get user from middleware (populated during auth verification)
const user = Astro.locals.user;

// Fetch dashboard data server-side
let dashboard: DashboardDTO | null = null;
let usage: UsageDailyDTO | null = null;
let error: string | null = null;

try {
  const baseUrl = Astro.url.origin;
  
  // Forward original cookies to internal API calls
  const cookieHeader = Astro.request.headers.get('Cookie');
  const headers: Record<string, string> = {};
  if (cookieHeader) {
    headers['Cookie'] = cookieHeader;
  }

  // Fetch usage data and dashboard data in parallel
  const [usageResponse, dashboardResponse] = await Promise.all([
    fetch(`${baseUrl}/api/usage/daily`, { headers }),
    fetch(`${baseUrl}/api/dashboard?include_events=true`, { headers }),
  ]);

  if (!usageResponse.ok) {
    throw new Error('Failed to fetch usage data');
  }

  if (!dashboardResponse.ok) {
    throw new Error('Failed to fetch dashboard data');
  }

  usage = await usageResponse.json();
  dashboard = await dashboardResponse.json();
} catch (err) {
  console.error('Error loading dashboard:', err);
  error = 'Wystąpił błąd podczas ładowania danych. Spróbuj ponownie później.';
}
---

<Layout title="Dashboard - SmartWordsAI">
  <main class="min-h-screen bg-gray-50">
    {error ? (
      <div class="container mx-auto px-4 py-8">
        <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
          {error}
        </div>
        <button 
          onclick="window.location.reload()" 
          class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          Odśwież
        </button>
      </div>
    ) : dashboard && usage ? (
      <div class="container mx-auto px-4 py-8">
        <!-- Top Navigation Bar -->
        <div class="mb-6 flex items-center justify-between">
          <div class="text-xl font-bold text-blue-600">
            SmartWordsAI
          </div>
          <UserMenu userEmail={user?.email ?? null} client:load />
        </div>

        <!-- Dashboard Header -->
        <header class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <p class="text-gray-600 mt-1">Witaj ponownie! Kontynuuj naukę.</p>
          </div>
          
          <!-- Generation Counter - React Component -->
          <GenerationCounter usage={usage} client:load />
        </header>

        <!-- Dashboard Grid - React Component -->
        <DashboardGrid dashboard={dashboard} usage={usage} client:load />
      </div>
    ) : (
      <div class="container mx-auto px-4 py-8 text-center">
        <div class="text-gray-600">Ładowanie...</div>
      </div>
    )}
  </main>
</Layout>

